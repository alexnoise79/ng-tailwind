<div class="relative" (uiOutsideClick)="onOutsideClick()" uiOutsideClick>
  <!-- Input field -->
  <div class="relative">
    <input
      #inputElement
      type="text"
      [value]="getFormattedDate()"
      [disabled]="disabled()"
      (focus)="onInputFocus()"
      (blur)="onTouched()"
      readonly
      class="w-full px-3 py-2 text-sm text-gray-900 dark:text-white bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 disabled:opacity-50 disabled:cursor-not-allowed"
      [class.pr-10]="showIcon()"
      placeholder="Select a date"
      aria-label="Date picker input"
    />
    @if (showIcon()) {
      <button type="button" (click)="onIconClick()" [disabled]="disabled()" class="absolute right-2 top-1/2 -translate-y-1/2 p-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded disabled:opacity-50 disabled:cursor-not-allowed" aria-label="Open date picker">
        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
      </button>
    }
  </div>

  <!-- Calendar popup -->
  @if (isOpen()) {
    <div
      [class.bottom-full]="position() === 'top'"
      [class.mb-1]="position() === 'top'"
      [class.top-full]="position() === 'bottom'"
      [class.mt-1]="position() === 'bottom'"
      [class]="'absolute z-50 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 ' + calendarPaddingClasses()"
      role="application"
      aria-label="Date picker"
    >
      <!-- Header -->
      <div [class]="'flex items-center justify-between ' + headerMarginClasses()">
        <button
          [disabled]="disabled()"
          (click)="previousMonth()"
          type="button"
          class="p-1 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed"
          aria-label="Previous month"
        >
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        </button>

        <div class="flex items-center gap-2">
          <select
            [disabled]="disabled()"
            [value]="currentMonth()"
            (change)="onMonthChange($event)"
            class="px-3 py-1 text-sm font-semibold text-gray-900 dark:text-white bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed"
            aria-label="Select month"
          >
            @for (month of availableMonths(); track month.value) {
              <option [value]="month.value">{{ month.name }}</option>
            }
          </select>
          <select
            [disabled]="disabled()"
            [value]="currentYear()"
            (change)="onYearChange($event)"
            class="px-3 py-1 text-sm font-semibold text-gray-900 dark:text-white bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed"
            aria-label="Select year"
          >
            @for (year of availableYears(); track year) {
              <option [value]="year">{{ year }}</option>
            }
          </select>
        </div>

        <button
          [disabled]="disabled()"
          (click)="nextMonth()"
          type="button"
          class="p-1 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed"
          aria-label="Next month"
        >
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </button>
      </div>

      <!-- Day names header -->
      <div [class]="'grid grid-cols-7 gap-1 ' + dayNamesMarginClasses()">
        @for (dayName of dayNames; track dayName) {
          <div [class]="dayNameCellClasses() + ' flex items-center justify-center font-semibold text-gray-500 dark:text-gray-400'">
            {{ dayName }}
          </div>
        }
      </div>

      <!-- Calendar grid -->
      <div class="grid grid-cols-7 gap-1" role="grid" aria-label="Calendar">
        @for (date of calendarDays(); track date ? `${date.year}-${date.month}-${date.day}` : $index) {
          @if (date) {
            <button [class]="getDateClasses(date)" [disabled]="isDisabled(date)" [attr.aria-label]="'Select ' + monthNames[date.month - 1] + ' ' + date.day + ', ' + date.year" [attr.aria-selected]="isSelected(date)" [attr.aria-disabled]="isDisabled(date)" (click)="selectDate(date)" type="button" role="gridcell">
              {{ date.day }}
            </button>
          } @else {
            <div [class]="emptyCellClasses()"></div>
          }
        }
      </div>

      <!-- Time selection -->
      @if (shouldShowTime()) {
        <div [class]="'border-t border-gray-200 dark:border-gray-700 flex justify-center ' + timeSectionMarginClasses()">
          <ngt-timepicker [model]="currentTime()" [disabled]="disabled()" [showSeconds]="true" [size]="size()" [hourStep]="hourStep()" [minuteStep]="minuteStep()" [secondStep]="secondStep()" (timeSelect)="onTimeChange($event)"></ngt-timepicker>
        </div>
      }
    </div>
  }
</div>
